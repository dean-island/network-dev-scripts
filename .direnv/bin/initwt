#!/usr/bin/env bash

ROOT_DIR=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
cd "$ROOT_DIR"

# Helper function to add line to .envrc if it doesn't exist
add_to_envrc_if_missing() {
    local line="$1"
    local file=".envrc"

    # Create .envrc if it doesn't exist
    touch "$file"

    # Check if the line already exists
    if ! grep -Fxq "$line" "$file"; then
        echo "$line" >> "$file"
    fi
}

(
    mkdir -p .direnv/bin

    # Add lines to .envrc only if they don't exist
    add_to_envrc_if_missing "source_up"
    add_to_envrc_if_missing "PATH_add $ROOT_DIR/.direnv/bin"

    # Only copy scripts if source exists and target doesn't have files yet
    if [ -d "ipa-connector-operator/scripts" ] && [ -z "$(ls -A .direnv/bin)" ]; then
        cp -r ipa-connector-operator/scripts/ .direnv/bin 2>/dev/null
    fi
)

direnv allow
