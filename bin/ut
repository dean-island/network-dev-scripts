#!/usr/bin/env bash

ROOT_DIR=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
(
    test_name=$1
    shift

    set -e
    cd "$ROOT_DIR" || (echo failed to cd to "$ROOT_DIR" && exit 1)
    full_path="$(dirname "$(rg "$test_name" | head -1 | awk '{print $1}')")"
    first="core-network"
    pkg_path="."
    if [ ! "$full_path" = "." ]; then
        IFS='/' read -r first pkg_path <<<"$full_path"
        echo "full path found for test is $full_path"
    else
        echo "did not find full path for test $test_name"
        exit 0
    fi
    cd "$first"

    CGO_CFLAGS="-Wno-gnu-folding-constant" go test ./"$pkg_path"/... -run "$test_name" -p=1 -parallel=8 -race "$@" 2>&1 | rg -v "ld: warning"
)
